{% extends 'base.html' %}
{% block title %}files{% endblock %}

{% block body %}
<div id="drop_zone">
    <header>
        <div>
            {% if username %}
            <span class="header_btn"><a href="{{ url_for('user_settings') }}">ðŸ‘¤ {{ username }}</a></span>
            {% else %}
            <span class="header_btn">Not Authenticated</span>
            {% endif %}
        </div>
        <div>
            <label class="header_btn" for="upload_button" id="upload_label">Upload</label>
            <input id="upload_button" type="file" hidden multiple>
        </div>
    </header>
    <div>
        <progress id="progress_bar" max=100 value=0 style="visibility: hidden;"></progress>
    </div>
    <section id="file_container">
        <div id="file_list">
            loading scripts... <br />
            if this text does not disappear, please enable javascript. <br />
            i'll probably have a js-free page in the future
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='file_upload.js') }}"></script>
<script type="text/javascript">
    CURRENT_PATH = '';

    var dropZone_refs = 0;
    dropZone = document.getElementById('drop_zone')
    dropZone.ondragleave = (event) => {
        event.preventDefault();
        dropZone_refs -= 1;
        if (dropZone_refs <= 0) {
        event.currentTarget.classList.remove('dragging');
        }
    }
    dropZone.ondragenter = (event) => {
        event.preventDefault();
        dropZone_refs += 1;
        event.currentTarget.classList.add('dragging');
    }
    dropZone.addEventListener("paste", (e) => {
        e.preventDefault();
        uploadFiles(e.clipboardData);
    });
    dropZone.ondragover = (event) => {
        event.preventDefault();
    }
    dropZone.ondrop = (event) => {
        event.preventDefault();
        event.currentTarget.classList.remove('dragging');
        uploadFiles(event.dataTransfer);
    }

    document.getElementById('upload_button').onchange = (event) => {
        let dataTransfer = new DataTransfer();
        dataTransfer.items.add(event.currentTarget.files[0])
        uploadFiles(dataTransfer);
    }

    async function uploadFiles(dataTransfer) {
        if (!dataTransfer.files.length) {
            return;
        }
        let progressBar = document.getElementById('progress_bar');
        progressBar.value = 0;
        progressBar.style.visibility = "visible";

        let files = dataTransfer.items;
        let formData = new FormData();
        formData.append('uploadPath', CURRENT_PATH);

        let numFiles = files.length;
        let numFilesDone = 0;

        for (let i = 0; i < numFiles; i++) {
            const item = files[i];
            if (!item) {
                // WHY ARE THERE BLANK ITEMS? CHROMIUM CAN SUCK MY DICK AND BALLS
                continue;
            }
            if (item.kind === "file") {
                numFilesDone++;
                progressBar.value = (numFilesDone / numFiles) * 100;
                if (typeof item.webkitGetAsEntry === "function" && item.webkitGetAsEntry()) {
                    const entry = item.webkitGetAsEntry();
                    const entryContent = await readEntryContentAsync(entry);
                    ([...entryContent]).forEach((file, i) => {
                        formData.append('file', file);
                    })
                    continue;
                }

                const file = item.getAsFile();
                if (file) {
                    formData.append('file', file);
                }
            }
        }
        fetch("{{ url_for('composer.upload_file') }}",{
            method: "POST",
            body: formData
        }).then((response) => {
            progressBar.style.visibility = "hidden";
            composeFileList(CURRENT_PATH);
        }).catch((e) => {
            // progressBar.style.visibility = "hidden"; // Probably unnecessary
            console.log(e);
        });
    }

    async function composeFileList(path) {
        document.getElementById('file_list').innerHTML = '<span class="loader"></span>';
        CURRENT_PATH = path;
        // {% if anchor_navigation %}
        window.location.hash = `#${path}`;
        // {% endif %}
        let response = await fetch("{{ url_for('composer.compose_file_list') }}" + path).catch((e) => {
                document.getElementById('file_list').innerHTML = '<span class="internet_disconnect"><span>X</span></span>';
            });
        if (response.redirected) {
            window.location = response.url;
        } else {
            response.text().then(
                body => {
                    document.getElementById('file_container').innerHTML = body;
                }
            );
        }
    }

    function shareFile(self, path) {
        self.parentNode.parentNode.blur();
        console.log("Sharing")
        console.log(path);
    }

    function renameFile(self, path) {
        self.parentNode.parentNode.blur();
        console.log('Renaming');
        console.log(path);
    }

    function deleteFile(self, path) {
        self.parentNode.parentNode.blur();
        console.log("Deleting");
        console.log(path);
    }

    window.onload = () => {
        composeFileList(window.location.hash.substring(1));
    };
    // {% if anchor_navigation %}
    window.addEventListener('hashchange', () => {
        composeFileList(window.location.hash.substring(1));
    });
    // {% endif %}
</script>
{% endblock %}
